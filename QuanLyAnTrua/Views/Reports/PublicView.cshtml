@model QuanLyAnTrua.Models.ViewModels.MonthlyReportViewModel
@using QuanLyAnTrua.Helpers

@{
    ViewData["Title"] = "Báo cáo thanh toán";
    Layout = null;
    var reportType = ViewBag.ReportType as string ?? "Group";
    var expiresAt = ViewBag.ExpiresAt as DateTime?;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Quản lý ăn trưa</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 10px 0;
        }
        .report-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        @@media (min-width: 768px) {
            body {
                padding: 20px 0;
            }
            .report-container {
                padding: 30px;
            }
        }
        .header-section {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .expire-notice {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        /* Mobile-friendly cards */
        .debt-card {
            margin-bottom: 15px;
        }
        .debt-card .card-body {
            padding: 15px;
        }
        @@media (min-width: 768px) {
            .debt-card .card-body {
                padding: 20px;
            }
        }
        /* Responsive tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-responsive table {
            min-width: 600px;
            font-size: 0.9rem;
        }
        @@media (min-width: 768px) {
            .table-responsive table {
                font-size: 1rem;
                min-width: auto;
            }
        }
        /* Mobile-friendly QR code section */
        .qr-section {
            text-align: center;
            padding: 10px;
            margin-top: 15px;
        }
        .qr-section img {
            max-width: 120px;
            margin: 0 auto;
        }
        @@media (min-width: 768px) {
            .qr-section {
                padding: 0;
                margin-top: 0;
            }
            .qr-section img {
                max-width: 150px;
            }
        }
        /* Mobile-friendly debt info */
        .debt-info-mobile {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .debt-info-mobile .debt-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
            margin: 10px 0;
        }
        @@media (min-width: 768px) {
            .debt-info-mobile {
                display: none;
            }
        }
        /* Hide desktop layout on mobile */
        .debt-info-desktop {
            display: none;
        }
        @@media (min-width: 768px) {
            .debt-info-desktop {
                display: block;
            }
        }
        /* Mobile-friendly button */
        .btn-mobile {
            width: 100%;
            padding: 10px;
            font-size: 0.95rem;
            margin-top: 10px;
        }
        @@media (min-width: 768px) {
            .btn-mobile {
                width: auto;
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
        }
        /* Sticky header for mobile */
        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        @@media (min-width: 768px) {
            .section-title {
                font-size: 1.5rem;
                padding: 15px;
            }
        }
        /* Nút chuyển tiền ngay - chỉ hiển thị trên mobile */
        .btn-transfer-mobile {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            margin-top: 10px;
            margin-bottom: 10px;
            display: block;
        }
        @@media (min-width: 768px) {
            .btn-transfer-mobile {
                display: none;
            }
        }
        /* Modal chọn app ngân hàng */
        .bank-app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            padding: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .bank-app-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .bank-app-item:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .bank-app-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .bank-app-item .bank-name {
            font-size: 0.85rem;
            color: #333;
            margin-top: 5px;
            word-break: break-word;
        }
        .loading-banks {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-container">
            <div class="header-section">
                <h1><i class="bi bi-file-earmark-text"></i> Báo cáo thanh toán</h1>
                <h3 class="text-muted">Tháng @Model.Month/@Model.Year</h3>
                @if (expiresAt.HasValue)
                {
                    <div class="expire-notice">
                        <i class="bi bi-exclamation-triangle"></i> Link này sẽ hết hạn vào: @expiresAt.Value.ToString("dd/MM/yyyy HH:mm")
                    </div>
                }
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="card-body text-white">
                            <h6 class="card-subtitle mb-2 opacity-75">Tổng chi phí</h6>
                            <h3 class="mb-0 fw-bold">@Model.TotalExpenses.ToString("N0") đ</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="card-body text-white">
                            <h6 class="card-subtitle mb-2 opacity-75">Số giao dịch</h6>
                            <h3 class="mb-0 fw-bold">@Model.TotalTransactions</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="card-body text-white">
                            <h6 class="card-subtitle mb-2 opacity-75">Tổng đã thanh toán</h6>
                            <h3 class="mb-0 fw-bold">@Model.UserDebts.Sum(d => d.PaidAmount).ToString("N0") đ</h3>
                        </div>
                    </div>
                </div>
            </div>

            @* Hiển thị "Bạn cần trả cho" *@
            @{
                var usersWithDebtsToShow = new List<dynamic>();
                
                if (reportType == "User" && Model.CurrentUserId.HasValue)
                {
                    // Hiển thị nợ của user cụ thể - chỉ các khoản nợ còn lại
                    var userDebt = Model.UserDebts.FirstOrDefault(u => u.UserId == Model.CurrentUserId.Value);
                    if (userDebt != null && userDebt.DebtDetails.Any())
                    {
                        // Chỉ lấy các khoản nợ còn lại (RemainingAmount > 0)
                        var remainingDebtDetails = userDebt.DebtDetails
                            .Where(d => d.RemainingAmount > 0)
                            .ToList();

                        if (remainingDebtDetails.Any())
                        {
                            var creditorGroups = remainingDebtDetails
                                .GroupBy(d => d.CreditorId)
                                .ToList();
                            
                            foreach (var group in creditorGroups)
                            {
                                var creditorId = group.Key;
                                var creditor = Model.UserDebts.FirstOrDefault(u => u.UserId == creditorId);
                                if (creditor != null)
                                {
                                    // Tính tổng số tiền còn nợ (RemainingAmount)
                                    var totalMyDebt = group.Sum(d => d.RemainingAmount);
                                    var myDebtDetails = group.ToList();
                                    
                                    if (totalMyDebt > 0)
                                    {
                                        usersWithDebtsToShow.Add(new
                                        {
                                            UserId = userDebt.UserId,
                                            UserName = userDebt.UserName,
                                            Creditor = new
                                            {
                                                CreditorId = creditorId,
                                                CreditorName = creditor.UserName,
                                                BankName = creditor.BankName,
                                                BankAccount = creditor.BankAccount,
                                                AccountHolderName = creditor.AccountHolderName
                                            },
                                            TotalMyDebt = totalMyDebt,
                                            MyDebtDetails = myDebtDetails
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
                else if (reportType == "Group")
                {
                    // Hiển thị nợ của tất cả users trong nhóm - chỉ các khoản nợ còn lại
                    foreach (var userDebt in Model.UserDebts.Where(u => u.DebtDetails.Any(d => d.RemainingAmount > 0)))
                    {
                        // Chỉ lấy các khoản nợ còn lại (RemainingAmount > 0)
                        var remainingDebtDetails = userDebt.DebtDetails
                            .Where(d => d.RemainingAmount > 0)
                            .ToList();

                        if (remainingDebtDetails.Any())
                        {
                            var creditorGroups = remainingDebtDetails
                                .GroupBy(d => d.CreditorId)
                                .ToList();
                            
                            foreach (var group in creditorGroups)
                            {
                                var creditorId = group.Key;
                                var creditor = Model.UserDebts.FirstOrDefault(u => u.UserId == creditorId);
                                if (creditor != null)
                                {
                                    // Tính tổng số tiền còn nợ (RemainingAmount)
                                    var totalMyDebt = group.Sum(d => d.RemainingAmount);
                                    var myDebtDetails = group.ToList();
                                    
                                    if (totalMyDebt > 0)
                                    {
                                        usersWithDebtsToShow.Add(new
                                        {
                                            UserId = userDebt.UserId,
                                            UserName = userDebt.UserName,
                                            Creditor = new
                                            {
                                                CreditorId = creditorId,
                                                CreditorName = creditor.UserName,
                                                BankName = creditor.BankName,
                                                BankAccount = creditor.BankAccount,
                                                AccountHolderName = creditor.AccountHolderName
                                            },
                                            TotalMyDebt = totalMyDebt,
                                            MyDebtDetails = myDebtDetails
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Nhóm theo user để hiển thị
                var groupedByUser = usersWithDebtsToShow.GroupBy(u => u.UserId).ToList();
            }
            
            @if (groupedByUser.Any())
            {
                @foreach (var userGroup in groupedByUser)
                {
                    var userInfo = userGroup.First();
                    <div class="sticky-header">
                        <h3 class="section-title mb-0">
                            <i class="bi bi-credit-card-2-front"></i> @userInfo.UserName cần trả cho
                        </h3>
                    </div>
                    <div class="row mb-4">
                        @foreach (var myDebt in userGroup)
                        {
                            <div class="col-12 col-md-6 mb-3">
                                <div class="card border-warning debt-card">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="bi bi-person-check"></i> @myDebt.Creditor.CreditorName</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Mobile Layout -->
                                        <div class="debt-info-mobile">
                                            <div class="text-center">
                                                <small class="text-muted">Tổng số tiền cần trả</small>
                                                <div class="debt-amount">@myDebt.TotalMyDebt.ToString("N0") đ</div>
                                            </div>
                                            
                                            @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName) && !string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                            {
                                                var roundedAmountMobile = Math.Ceiling(myDebt.TotalMyDebt);
                                                var qrCodeUrlMobile = Url.Action("GenerateQRCode", "Reports", new { 
                                                    bankName = myDebt.Creditor.BankName, 
                                                    bankAccount = myDebt.Creditor.BankAccount, 
                                                    accountHolderName = myDebt.Creditor.AccountHolderName ?? "", 
                                                    amount = roundedAmountMobile,
                                                    creditorId = myDebt.Creditor.CreditorId,
                                                    userId = userInfo.UserId,
                                                    year = Model.Year,
                                                    month = Model.Month
                                                });
                                                <div class="qr-section">
                                                    <img src="@qrCodeUrlMobile" alt="QR Code" 
                                                        class="img-fluid" 
                                                        style="cursor: pointer;"
                                                        onclick="showQRCodeModal('@myDebt.Creditor.CreditorName', '@myDebt.TotalMyDebt.ToString("N0")', '@qrCodeUrlMobile')" />
                                                    <br />
                                                    <button class="btn btn-sm btn-outline-primary mt-2" 
                                                            onclick="showQRCodeModal('@myDebt.Creditor.CreditorName', '@myDebt.TotalMyDebt.ToString("N0")', '@qrCodeUrlMobile')">
                                                        <i class="bi bi-qr-code-scan"></i> Xem QR lớn
                                                    </button>
                                                </div>
                                            }
                                            
                                            <div class="mt-3">
                                                @{
                                                    var transferContentMobile = IdEncoderHelper.CreatePaymentDescription(
                                                        myDebt.Creditor.CreditorId, 
                                                        userInfo.UserId, 
                                                        Model.Year, 
                                                        Model.Month
                                                    );
                                                    var roundedAmountMobileForCopy = Math.Ceiling(myDebt.TotalMyDebt);
                                                }
                                                <strong><i class="bi bi-bank"></i> Thông tin ngân hàng:</strong><br />
                                                @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName))
                                                {
                                                    <small>Ngân hàng: <strong>@myDebt.Creditor.BankName</strong></small><br />
                                                }
                                                @if (!string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                                {
                                                    <small>
                                                        Số TK: <strong class="text-primary">@myDebt.Creditor.BankAccount</strong>
                                                        <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@myDebt.Creditor.BankAccount" title="Copy số tài khoản">
                                                            <i class="bi bi-clipboard" style="font-size: 0.85rem;"></i>
                                                        </button>
                                                    </small><br />
                                                }
                                                @if (!string.IsNullOrEmpty(myDebt.Creditor.AccountHolderName))
                                                {
                                                    <small>Chủ TK: @myDebt.Creditor.AccountHolderName</small><br />
                                                }
                                                <small>
                                                    Số tiền: <strong>@roundedAmountMobileForCopy.ToString("N0") đ</strong>
                                                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@((int)roundedAmountMobileForCopy)" title="Copy số tiền">
                                                        <i class="bi bi-clipboard" style="font-size: 0.85rem;"></i>
                                                    </button>
                                                </small><br />
                                                <small>
                                                    Nội dung CK: <strong>@transferContentMobile</strong>
                                                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@transferContentMobile" title="Copy nội dung chuyển khoản">
                                                        <i class="bi bi-clipboard" style="font-size: 0.85rem;"></i>
                                                    </button>
                                                </small>
                                            </div>

                                            <details class="mt-3">
                                                <summary class="btn btn-sm btn-outline-info w-100">Xem chi tiết các khoản nợ</summary>
                                                <ul class="mt-2 text-start">
                                                    @foreach (var detail in ((IEnumerable<QuanLyAnTrua.Models.ViewModels.DebtDetail>)myDebt.MyDebtDetails).OrderBy(d => d.ExpenseDate))
                                                    {
                                                        <li class="mb-1">
                                                            <small>@detail.ExpenseDate.ToString("dd/MM/yyyy"): 
                                                                @if (detail.Amount != detail.RemainingAmount)
                                                                {
                                                                    <span>@detail.RemainingAmount.ToString("N0") đ (ban đầu: @detail.Amount.ToString("N0") đ)</span>
                                                                }
                                                                else
                                                                {
                                                                    <span>@detail.RemainingAmount.ToString("N0") đ</span>
                                                                }
                                                            </small>
                                                            @if (!string.IsNullOrEmpty(detail.Description))
                                                            {
                                                                <br /><small class="text-muted">@detail.Description</small>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                            </details>

                                            @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName) && !string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                            {
                                                <button type="button" 
                                                        class="btn btn-primary btn-transfer-mobile" 
                                                        onclick="showBankAppModal()">
                                                    <i class="bi bi-arrow-right-circle"></i> Chuyển tiền ngay
                                                </button>
                                                <small class="text-muted d-block mt-2">
                                                    <i class="bi bi-info-circle"></i> Lưu ý: Vui lòng tải QR code về trước khi chọn app ngân hàng
                                                </small>
                                            }
                                            <button type="button" id="btnPay_mobile_@(userInfo.UserId)_@(myDebt.Creditor.CreditorId)" class="btn btn-success btn-mobile" onclick="markAsPaid('@ViewBag.Token', @userInfo.UserId, @myDebt.TotalMyDebt.ToString("F2", System.Globalization.CultureInfo.InvariantCulture), '@myDebt.Creditor.CreditorName', '@myDebt.Creditor.CreditorId')">
                                                <i class="bi bi-check-circle"></i> Xác nhận đã thanh toán
                                            </button>
                                            <div id="paymentStatus_@(userInfo.UserId)_@(myDebt.Creditor.CreditorId)" class="mt-2"></div>
                                        </div>

                                        <!-- Desktop Layout -->
                                        <div class="debt-info-desktop">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <p class="mb-2">
                                                        <strong>Tổng số tiền cần trả: </strong>
                                                        <span class="text-danger fw-bold fs-5">@myDebt.TotalMyDebt.ToString("N0") đ</span>
                                                    </p>
                                                    
                                                    @{
                                                        var transferContentDesktop = !string.IsNullOrEmpty(myDebt.Creditor.BankName) && !string.IsNullOrEmpty(myDebt.Creditor.BankAccount)
                                                            ? IdEncoderHelper.CreatePaymentDescription(
                                                                myDebt.Creditor.CreditorId, 
                                                                userInfo.UserId, 
                                                                Model.Year, 
                                                                Model.Month
                                                            )
                                                            : "";
                                                        var roundedAmountDesktopForCopy = Math.Ceiling(myDebt.TotalMyDebt);
                                                    }
                                                    
                                                    @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName) || !string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                                    {
                                                        <p class="mb-2">
                                                            <strong><i class="bi bi-bank"></i> Thông tin ngân hàng:</strong><br />
                                                            @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName))
                                                            {
                                                                <span>Ngân hàng: @myDebt.Creditor.BankName</span><br />
                                                            }
                                                            @if (!string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                                            {
                                                                <span>
                                                                    Số tài khoản: <strong>@myDebt.Creditor.BankAccount</strong>
                                                                    <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@myDebt.Creditor.BankAccount" title="Copy số tài khoản">
                                                                        <i class="bi bi-clipboard"></i>
                                                                    </button>
                                                                </span><br />
                                                            }
                                                            @if (!string.IsNullOrEmpty(myDebt.Creditor.AccountHolderName))
                                                            {
                                                                <span>Chủ tài khoản: @myDebt.Creditor.AccountHolderName</span><br />
                                                            }
                                                            <span>
                                                                Số tiền: <strong>@roundedAmountDesktopForCopy.ToString("N0") đ</strong>
                                                                <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@((int)roundedAmountDesktopForCopy)" title="Copy số tiền">
                                                                    <i class="bi bi-clipboard"></i>
                                                                </button>
                                                            </span><br />
                                                            <span>
                                                                Nội dung CK: <strong>@transferContentDesktop</strong>
                                                                <button type="button" class="btn btn-sm btn-link p-0 ms-1" data-copy="@transferContentDesktop" title="Copy nội dung chuyển khoản">
                                                                    <i class="bi bi-clipboard"></i>
                                                                </button>
                                                            </span>
                                                        </p>
                                                    }

                                                    <details class="mb-2">
                                                        <summary class="btn btn-sm btn-outline-info">Xem chi tiết các khoản nợ</summary>
                                                        <ul class="mt-2">
                                                            @foreach (var detail in ((IEnumerable<QuanLyAnTrua.Models.ViewModels.DebtDetail>)myDebt.MyDebtDetails).OrderBy(d => d.ExpenseDate))
                                                            {
                                                                <li>
                                                                    <small>@detail.ExpenseDate.ToString("dd/MM/yyyy"): 
                                                                        @if (detail.Amount != detail.RemainingAmount)
                                                                        {
                                                                            <span>@detail.RemainingAmount.ToString("N0") đ (ban đầu: @detail.Amount.ToString("N0") đ)</span>
                                                                        }
                                                                        else
                                                                        {
                                                                            <span>@detail.RemainingAmount.ToString("N0") đ</span>
                                                                        }
                                                                    </small>
                                                                    @if (!string.IsNullOrEmpty(detail.Description))
                                                                    {
                                                                        <small class="text-muted"> - @detail.Description</small>
                                                                    }
                                                                </li>
                                                            }
                                                        </ul>
                                                    </details>

                                                    <div class="mt-3">
                                                        <button type="button" id="btnPay_desktop_@(userInfo.UserId)_@(myDebt.Creditor.CreditorId)" class="btn btn-success btn-sm" onclick="markAsPaid('@ViewBag.Token', @userInfo.UserId, @myDebt.TotalMyDebt.ToString("F2", System.Globalization.CultureInfo.InvariantCulture), '@myDebt.Creditor.CreditorName', '@myDebt.Creditor.CreditorId')">
                                                            <i class="bi bi-check-circle"></i> Xác nhận đã thanh toán thành công!
                                                        </button>
                                                        <div id="paymentStatus_@(userInfo.UserId)_@(myDebt.Creditor.CreditorId)" class="mt-2"></div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    @if (!string.IsNullOrEmpty(myDebt.Creditor.BankName) && !string.IsNullOrEmpty(myDebt.Creditor.BankAccount))
                                                    {
                                                        var qrCodeUrl = Url.Action("GenerateQRCode", "Reports", new { 
                                                            bankName = myDebt.Creditor.BankName, 
                                                            bankAccount = myDebt.Creditor.BankAccount, 
                                                            accountHolderName = myDebt.Creditor.AccountHolderName ?? "", 
                                                            amount = roundedAmountDesktopForCopy,
                                                            creditorId = myDebt.Creditor.CreditorId,
                                                            userId = userInfo.UserId,
                                                            year = Model.Year,
                                                            month = Model.Month
                                                        });
                                                        <img src="@qrCodeUrl" alt="QR Code" 
                                                            class="img-fluid" 
                                                            style="max-width: 150px; cursor: pointer;"
                                                            onclick="showQRCodeModal('@myDebt.Creditor.CreditorName', '@myDebt.TotalMyDebt.ToString("N0")', '@qrCodeUrl')" />
                                                        <br />
                                                        <small class="text-muted">Mã QR chuyển khoản</small>
                                                        <br />
                                                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                                                onclick="showQRCodeModal('@myDebt.Creditor.CreditorName', '@myDebt.TotalMyDebt.ToString("N0")', '@qrCodeUrl')">
                                                            <i class="bi bi-qr-code-scan"></i> Xem QR lớn
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted">Chưa có thông tin ngân hàng</small>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <hr />
                }
            }

            <h3 class="section-title mb-3"><i class="bi bi-people"></i> Chi tiết nợ theo người dùng</h3>
            @if (Model.UserDebts.Any())
            {
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Người dùng</th>
                                <th>Phải trả</th>
                                <th>Đã chi</th>
                                <th>Nợ thực tế</th>
                                <th>Đã thanh toán</th>
                                <th>Còn lại</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var userDebt in Model.UserDebts.OrderBy(u => u.UserName))
                            {
                                <tr>
                                    <td>
                                        <strong>@userDebt.UserName</strong>
                                        @if (!string.IsNullOrEmpty(userDebt.BankName) || !string.IsNullOrEmpty(userDebt.BankAccount))
                                        {
                                            <br />
                                            <small class="text-muted">
                                                <i class="bi bi-bank"></i>
                                                @if (!string.IsNullOrEmpty(userDebt.BankName))
                                                {
                                                    <span>@userDebt.BankName</span>
                                                }
                                                @if (!string.IsNullOrEmpty(userDebt.BankAccount))
                                                {
                                                    <span> - @userDebt.BankAccount</span>
                                                }
                                                @if (!string.IsNullOrEmpty(userDebt.AccountHolderName))
                                                {
                                                    <span> - @userDebt.AccountHolderName</span>
                                                }
                                            </small>
                                        }
                                    </td>
                                    <td>@userDebt.TotalAmount.ToString("N0") đ</td>
                                    <td>@userDebt.PaidAsPayer.ToString("N0") đ</td>
                                    <td>
                                        @if (userDebt.ActualDebt > 0)
                                        {
                                            <span class="text-danger fw-bold">@userDebt.ActualDebt.ToString("N0") đ</span>
                                        }
                                        else if (userDebt.ActualDebt < 0)
                                        {
                                            <span class="text-success">@Math.Abs(userDebt.ActualDebt).ToString("N0") đ (được nợ)</span>
                                        }
                                        else
                                        {
                                            <span>0 đ</span>
                                        }
                                    </td>
                                    <td>@userDebt.PaidAmount.ToString("N0") đ</td>
                                    <td>
                                        @{
                                            var roundedRemaining = Math.Round(userDebt.RemainingAmount, 2);
                                        }
                                        @if (roundedRemaining > 0)
                                        {
                                            <span class="text-danger fw-bold">@roundedRemaining.ToString("N0") đ</span>
                                        }
                                        else if (roundedRemaining < 0)
                                        {
                                            <span class="text-success">@Math.Abs(roundedRemaining).ToString("N0") đ (thừa)</span>
                                        }
                                        else
                                        {
                                            <span>0 đ</span>
                                        }
                                    </td>
                                    <td>
                                        @if (userDebt.IsFullyPaid)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Đã thanh toán</span>
                                        }
                                        else if (userDebt.PaidAmount > 0)
                                        {
                                            <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> Thanh toán một phần</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Chưa thanh toán</span>
                                        }
                                    </td>
                                </tr>
                                @if (userDebt.Payments.Any())
                                {
                                    <tr>
                                        <td colspan="7" class="bg-light">
                                            <small><strong>Lịch sử thanh toán:</strong></small>
                                            <ul class="mb-0">
                                                @foreach (var payment in userDebt.Payments)
                                                {
                                                    <li>
                                                        <strong>@payment.UserName</strong> đã thanh toán: @payment.PaidAmount.ToString("N0") đ - @payment.PaidDate.ToString("dd/MM/yyyy")
                                                        @if (!string.IsNullOrEmpty(payment.Notes))
                                                        {
                                                            <span class="text-muted">(@payment.Notes)</span>
                                                        }
                                                    </li>
                                                }
                                            </ul>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                @if (Model.UserDebts.Any(u => u.DebtDetails.Any(d => d.RemainingAmount > 0)))
                {
                    <h3 class="section-title mb-3"><i class="bi bi-arrow-left-right"></i> Chi tiết ai nợ ai (còn nợ)</h3>
                    <div class="table-responsive mb-4">
                        <table class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Người nợ</th>
                                    <th>Nợ</th>
                                    <th>Người được nợ</th>
                                    <th>Số tiền ban đầu</th>
                                    <th>Số tiền còn nợ</th>
                                    <th>Ngày</th>
                                    <th>Mô tả</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var debt in Model.UserDebts)
                                {
                                    @foreach (var debtDetail in debt.DebtDetails.Where(d => d.RemainingAmount > 0))
                                    {
                                        <tr>
                                            <td><strong>@debtDetail.DebtorName</strong></td>
                                            <td><i class="bi bi-arrow-right text-danger"></i></td>
                                            <td><strong>@debtDetail.CreditorName</strong></td>
                                            <td>@debtDetail.Amount.ToString("N0") đ</td>
                                            <td class="text-danger fw-bold">@debtDetail.RemainingAmount.ToString("N0") đ</td>
                                            <td>@debtDetail.ExpenseDate.ToString("dd/MM/yyyy")</td>
                                            <td>@(debtDetail.Description ?? "-")</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Chưa có dữ liệu nợ cho tháng này.</p>
            }

            <h3 class="section-title mb-3"><i class="bi bi-list-ul"></i> Chi tiết các khoản chi</h3>
            @if (Model.Expenses.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Ngày chi</th>
                                <th>Số tiền</th>
                                <th>Người chi</th>
                                <th>Người ăn</th>
                                <th>Số tiền/người</th>
                                <th>Mô tả</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var expense in Model.Expenses.OrderByDescending(e => e.ExpenseDate))
                            {
                                <tr>
                                    <td>@expense.ExpenseDate.ToString("dd/MM/yyyy")</td>
                                    <td>@expense.Amount.ToString("N0") đ</td>
                                    <td>@expense.PayerName</td>
                                    <td>@string.Join(", ", expense.ParticipantNames)</td>
                                    <td>@expense.AmountPerPerson.ToString("N0") đ</td>
                                    <td>@(expense.Description ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Chưa có chi phí nào trong tháng này.</p>
            }
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrCodeModalLabel">Mã QR chuyển khoản</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p><strong id="qrCreditorName"></strong></p>
                    <p class="text-danger fw-bold fs-4" id="qrAmount"></p>
                    <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid" style="max-width: 300px;" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal để hiển thị QR Code lớn -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrCodeModalLabel">Mã QR chuyển khoản</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2"><strong id="qrCodeCreditorName"></strong></p>
                    <p class="mb-3">Số tiền: <span class="text-danger fw-bold" id="qrCodeAmount"></span> đ</p>
                    <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                    <p class="mt-3 text-muted small">Quét mã QR để chuyển khoản</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chọn app ngân hàng -->
    <div class="modal fade" id="bankAppModal" tabindex="-1" aria-labelledby="bankAppModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bankAppModalLabel">Chọn app ngân hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> <strong>Lưu ý:</strong> Vui lòng tải QR code về máy trước khi chọn app ngân hàng. Sau đó mở app và quét mã QR đã tải.
                    </div>
                    <div id="bankAppLoading" class="loading-banks">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tải danh sách app ngân hàng...</p>
                    </div>
                    <div id="bankAppError" class="alert alert-danger" style="display: none;"></div>
                    <div id="bankAppGrid" class="bank-app-grid" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Phát hiện thiết bị (Android/iOS)
        function detectDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/android/i.test(userAgent)) {
                return 'android';
            }
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return 'ios';
            }
            return 'unknown';
        }

        // Map ShortName sang appId (một số ngân hàng có appId khác với ShortName)
        const bankShortNameToAppId = {
            'VCB': 'vcb',
            'Vietin': 'vietin',
            'BIDV': 'bidv',
            'Agri': 'agribank',
            'TCB': 'tcb',
            'MB': 'mb',
            'ACB': 'acb',
            'TPBank': 'tpb',
            'VIB': 'vib',
            'VPBank': 'vpbank',
            'SHB': 'shb',
            'HDBank': 'hdb',
            'STB': 'stb',
            'Eximbank': 'eximbank',
            'MSB': 'msb',
            'OceanBank': 'oceanbank',
            'PVBank': 'pvcombank',
            'NAB': 'nab',
            'VID': 'vid',
            'NASBank': 'nasbank',
            'SCB': 'scb',
            'DAB': 'dab',
            'GPBank': 'gpbank',
            'HLO': 'hlo',
            'IVB': 'ivb',
            'Kienlongbank': 'kienlongbank',
            'LPB': 'lpb',
            'NCB': 'ncb',
            'OCB': 'ocb',
            'PG Bank': 'pgbank',
            'SeABank': 'seabank',
            'Shinhan': 'shinhan',
            'UOB': 'uob',
            'Vietbank': 'vietbank',
            'VAB': 'vab',
            'VietCapital': 'vietcapital',
            'VRB': 'vrb',
            'Woori': 'woori',
            'ABBank': 'abbank',
            'Baoviet': 'baoviet',
            'CIMB': 'cimb'
        };

        // Hàm chuyển đổi ShortName sang appId
        function shortNameToAppId(shortName) {
            return bankShortNameToAppId[shortName] || shortName.toLowerCase();
        }

        // Biến lưu modal instance
        let bankAppModalInstance = null;

        // Hiển thị modal chọn app ngân hàng
        function showBankAppModal() {
            const modalElement = document.getElementById('bankAppModal');
            if (!bankAppModalInstance) {
                bankAppModalInstance = new bootstrap.Modal(modalElement);
            }
            bankAppModalInstance.show();

            // Reset UI
            document.getElementById('bankAppLoading').style.display = 'block';
            document.getElementById('bankAppError').style.display = 'none';
            document.getElementById('bankAppGrid').style.display = 'none';
            document.getElementById('bankAppGrid').innerHTML = '';

            // Xác định API endpoint
            const device = detectDevice();
            let apiUrl;
            if (device === 'android') {
                apiUrl = 'https://api.vietqr.io/v2/android-app-deeplinks';
            } else if (device === 'ios') {
                apiUrl = 'https://api.vietqr.io/v2/ios-app-deeplinks';
            } else {
                // Nếu không phát hiện được, thử Android trước
                apiUrl = 'https://api.vietqr.io/v2/android-app-deeplinks';
            }

            // Gọi API VietQR
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('bankAppLoading').style.display = 'none';
                    
                    if (!data.apps || data.apps.length === 0) {
                        document.getElementById('bankAppError').textContent = 'Không tìm thấy app ngân hàng nào.';
                        document.getElementById('bankAppError').style.display = 'block';
                        return;
                    }

                    // Hiển thị TẤT CẢ app ngân hàng để người dùng chọn app của họ (người gửi)
                    const appsToShow = data.apps;

                    // Render danh sách app
                    const grid = document.getElementById('bankAppGrid');
                    appsToShow.forEach(app => {
                        const appItem = document.createElement('div');
                        appItem.className = 'bank-app-item';
                        appItem.onclick = function() {
                            openBankApp(app.appId);
                            if (bankAppModalInstance) {
                                bankAppModalInstance.hide();
                            }
                        };
                        appItem.innerHTML = `
                            <img src="${app.appLogo || ''}" alt="${app.appName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect width=\'60\' height=\'60\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' font-size=\'10\' fill=\'%23999\'%3E${app.appName.substring(0, 3)}%3C/text%3E%3C/svg%3E'">
                            <div class="bank-name">${app.appName}</div>
                        `;
                        grid.appendChild(appItem);
                    });

                    document.getElementById('bankAppGrid').style.display = 'grid';
                })
                .catch(error => {
                    document.getElementById('bankAppLoading').style.display = 'none';
                    document.getElementById('bankAppError').textContent = 'Có lỗi xảy ra khi tải danh sách app: ' + error.message;
                    document.getElementById('bankAppError').style.display = 'block';
                    console.error('Error fetching bank apps:', error);
                });
        }

        // Mở app ngân hàng
        function openBankApp(appId) {
            const deeplink = 'https://dl.vietqr.io/pay?app=' + appId;
            window.location.href = deeplink;
        }

        function showQRCodeModal(creditorName, amount, qrCodeUrl) {
            document.getElementById('qrCodeCreditorName').textContent = 'Chuyển tiền cho: ' + creditorName;
            document.getElementById('qrCodeAmount').textContent = amount;
            document.getElementById('qrCodeImage').src = qrCodeUrl;
            var modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
            modal.show();
        }

        // Copy to clipboard - đơn giản với data attribute
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-copy]');
            if (!btn) return;
            
            var textToCopy = btn.getAttribute('data-copy');
            var icon = btn.querySelector('i');
            var originalClass = icon ? icon.className : '';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(function() {
                    if (icon) {
                        icon.className = 'bi bi-check';
                        setTimeout(function() {
                            icon.className = originalClass;
                        }, 1000);
                    }
                }).catch(function(err) {
                    console.error('Failed to copy:', err);
                    // Fallback
                    var textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.top = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (icon) {
                        icon.className = 'bi bi-check';
                        setTimeout(function() {
                            icon.className = originalClass;
                        }, 1000);
                    }
                });
            } else {
                // Fallback cho trình duyệt cũ
                var textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                if (icon) {
                    icon.className = 'bi bi-check';
                    setTimeout(function() {
                        icon.className = originalClass;
                    }, 1000);
                }
            }
        });

        function markAsPaid(token, userId, amount, creditorName, creditorId) {
            var amountNum = parseFloat(amount);
            var formattedAmount = amountNum.toLocaleString('vi-VN');
            
            // Yêu cầu nhập nội dung chuyển khoản để đối soát
            var transferContent = prompt('Vui lòng nhập nội dung chuyển khoản để đối soát:\n(Ví dụ: Thanh toán cho ' + creditorName + ')', 'Thanh toán cho ' + creditorName);
            
            if (transferContent === null) {
                // Người dùng hủy
                return;
            }
            
            if (!transferContent || transferContent.trim() === '') {
                alert('Vui lòng nhập nội dung chuyển khoản!');
                return;
            }
            
            if (!confirm('Bạn có chắc chắn đã thanh toán ' + formattedAmount + ' đ cho ' + creditorName + '?\nNội dung CK: ' + transferContent)) {
                return;
            }

            // Tìm tất cả các nút (mobile và desktop)
            var btnPayMobile = document.getElementById('btnPay_mobile_' + userId + '_' + creditorId);
            var btnPayDesktop = document.getElementById('btnPay_desktop_' + userId + '_' + creditorId);
            var btnPayElements = [];
            
            if (btnPayMobile) btnPayElements.push(btnPayMobile);
            if (btnPayDesktop) btnPayElements.push(btnPayDesktop);
            
            var statusDiv = document.getElementById('paymentStatus_' + userId + '_' + creditorId);
            
            if (btnPayElements.length === 0) {
                console.error('Không tìm thấy nút thanh toán cho userId: ' + userId + ', creditorId: ' + creditorId);
                return;
            }
            
            // Lưu text ban đầu của nút đầu tiên để restore khi có lỗi
            var originalTexts = [];
            btnPayElements.forEach(function(btn) {
                originalTexts.push(btn.innerHTML);
            });
            
            // Vô hiệu hóa tất cả các nút và đổi trạng thái
            btnPayElements.forEach(function(btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-clock-history"></i> Chờ xác nhận...';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            });
            
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Đang xử lý...';

            fetch('@Url.Action("CreatePendingPayment", "Reports")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'token=' + encodeURIComponent(token) + 
                      '&userId=' + userId + 
                      '&amount=' + amount +
                      '&creditorId=' + creditorId +
                      '&notes=' + encodeURIComponent(transferContent)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Giữ nguyên trạng thái "Chờ xác nhận" cho tất cả các nút
                    btnPayElements.forEach(function(btn) {
                        btn.innerHTML = '<i class="bi bi-clock-history"></i> Chờ xác nhận';
                    });
                    statusDiv.innerHTML = '<div class="alert alert-info alert-sm py-1 mb-0"><i class="bi bi-info-circle"></i> ' + data.message + '</div>';
                } else {
                    // Khôi phục tất cả các nút nếu có lỗi
                    btnPayElements.forEach(function(btn, index) {
                        btn.disabled = false;
                        btn.innerHTML = originalTexts[index];
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-success');
                    });
                    statusDiv.innerHTML = '<div class="alert alert-danger alert-sm py-1 mb-0"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
                }
            })
            .catch(error => {
                // Khôi phục tất cả các nút nếu có lỗi
                btnPayElements.forEach(function(btn, index) {
                    btn.disabled = false;
                    btn.innerHTML = originalTexts[index];
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-success');
                });
                statusDiv.innerHTML = '<div class="alert alert-danger alert-sm py-1 mb-0"><i class="bi bi-x-circle"></i> Có lỗi xảy ra: ' + error + '</div>';
            });
        }

        // Auto-reload khi có payment mới
        (function() {
            const token = '@ViewBag.Token';
            if (!token) return;

            let isReloading = false;
            let lastPaymentId = null;

            // Tìm max payment ID từ tất cả payments trong trang
            function getMaxPaymentId() {
                let maxId = null;
                @foreach (var userDebt in Model.UserDebts)
                {
                    @foreach (var payment in userDebt.Payments)
                    {
                        <text>
                        if (maxId === null || @payment.Id > maxId) {
                            maxId = @payment.Id;
                        }
                        </text>
                    }
                }
                return maxId;
            }

            // Khởi tạo lastPaymentId khi trang load
            lastPaymentId = getMaxPaymentId();

            function checkForUpdates() {
                if (isReloading) return;

                // Cập nhật lastPaymentId từ trang hiện tại trước khi check
                const currentMaxId = getMaxPaymentId();
                if (currentMaxId !== null) {
                    lastPaymentId = currentMaxId;
                }

                let url = '@Url.Action("CheckUpdates", "Reports")?token=' + encodeURIComponent(token);
                if (lastPaymentId !== null) {
                    url += '&lastPaymentId=' + lastPaymentId;
                }

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.hasUpdate) {
                            isReloading = true;
                            // Hiển thị thông báo trước khi reload
                            const notification = document.createElement('div');
                            notification.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                            notification.style.zIndex = '9999';
                            notification.style.minWidth = '300px';
                            notification.innerHTML = `
                                <i class="bi bi-info-circle"></i> Có thanh toán mới! Đang tải lại trang...
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            document.body.appendChild(notification);
                            
                            // Reload sau 1 giây
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking for updates:', error);
                    });
            }

            // Check mỗi 5 giây
            setInterval(checkForUpdates, 5000);
            
            // Check ngay khi trang load (sau 2 giây để tránh check ngay lập tức)
            setTimeout(checkForUpdates, 2000);
        })();
    </script>
</body>
</html>

